name: Frontend - Build, Scan, and Push Images

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Artifact tag version"
        default: 'v0.0.1'
        required: true

# Set environment variables (use GitHub Secrets for sensitive values)
env:
  AZURE_CONTAINER_REGISTRY: ${{ vars.AZURE_CONTAINER_REGISTRY_NAME }} # e.g., mydevopsacr
  IMAGE_TAG: ${{ github.event.inputs.tag }}

permissions:
  id-token: write # Mandatory for Azure OIDC authentication
  contents: read # Allow checkout

jobs:
  # Job 1: Scan for secrets in the codebase before any build
  security-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gitleaks secret scanner
        uses: gitleaks/gitleaks-action@v2
        with:
          # This will fail the build if secrets are found
          verbose: true

  # Job 2: Build, Scan, and Push the Frontend Image
  build-frontend:
    name: Build & Push Frontend
    runs-on: ubuntu-latest
    # needs: security-scan # This job only runs if security-scan succeeds
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in with Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_MI_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: 'ACR login'
        run: |
          az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      - name: Build frontend image
        run: |
          docker build ./frontend -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:${{ env.IMAGE_TAG }}

      - name: Run Trivy vulnerability scanner on frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:${{ env.IMAGE_TAG }}'
          format: 'table'
          exit-code: '1' # Fail the job if vulnerabilities are found
          ignore-unfixed: true # Don't fail for vulnerabilities with no fix
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH' # Only fail on these severities

      - name: Push frontend image
        run: |
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:${{ env.IMAGE_TAG }}
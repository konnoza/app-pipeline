name: Build, Scan, and Push Images

on:
  push:
    branches:
      - main

# Set environment variables (use GitHub Secrets for sensitive values)
env:
  AZURE_CONTAINER_REGISTRY: 'acrmytestnatthasw' # e.g., mydevopsacr
  IMAGE_TAG: ${{ github.sha }} # Use SHA for a unique, consistent tag

permissions:
  id-token: write # Mandatory for Azure OIDC authentication
  contents: read # Allow checkout

jobs:
  # Job 1: Scan for secrets in the codebase before any build
  security-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gitleaks secret scanner
        uses: gitleaks/gitleaks-action@v2
        with:
          # This will fail the build if secrets are found
          verbose: true

  # Job 2: Build, Scan, and Push the Backend Image
  build-backend:
    name: Build & Push Backend
    runs-on: ubuntu-latest
    needs: security-scan # This job only runs if security-scan succeeds
    env:
      IMAGE_NAME: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: 'Azure login'
        uses: azure/login@v2
        with:
          client-id: b8ea3cc8-c18e-406e-aae6-605035570491
          tenant-id: 38ed0a87-0953-4206-adb3-d9f096bbce82
          subscription-id: 502d2b68-68b7-492d-87a3-a68571a5645a

      - name: 'ACR login'
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
      #     username: ${{ secrets.ACR_USERNAME }}
      #     password: ${{ secrets.ACR_PASSWORD }}

      - name: Build backend image
        run: |
          docker build ./backend -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # - name: Run Trivy vulnerability scanner on backend
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     image-ref: '${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}'
      #     format: 'table'
      #     exit-code: '1' # Fail the job if vulnerabilities are found
      #     ignore-unfixed: true # Don't fail for vulnerabilities with no fix
      #     vuln-type: 'os,library'
      #     severity: 'CRITICAL,HIGH' # Only fail on these severities

      - name: Push backend image
        run: |
          docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  # Job 3: Build, Scan, and Push the Frontend Image
  # build-frontend:
  #   name: Build & Push Frontend
  #   runs-on: ubuntu-latest
  #   needs: security-scan # This job only runs if security-scan succeeds
  #   env:
  #     IMAGE_NAME: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: 'Azure login'
  #       uses: azure/login@v2
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}

  #     - name: 'ACR login'
  #       uses: azure/docker-login@v1
  #       with:
  #         login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
  #         username: ${{ secrets.ACR_USERNAME }}
  #         password: ${{ secrets.ACR_PASSWORD }}

  #     - name: Build frontend image
  #       run: |
  #         docker build ./frontend -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  #     - name: Run Trivy vulnerability scanner on frontend
  #       uses: aquasecurity/trivy-action@master
  #       with:
  #         image-ref: '${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}'
  #         format: 'table'
  #         exit-code: '1' # Fail the job if vulnerabilities are found
  #         ignore-unfixed: true # Don't fail for vulnerabilities with no fix
  #         vuln-type: 'os,library'
  #         severity: 'CRITICAL,HIGH' # Only fail on these severities

  #     - name: Push frontend image
  #       run: |
  #         docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
name: Deploy infra stack

on:
  workflow_dispatch:
    # inputs:
    #   tag:
    #     description: "Artifact tag version"
    #     default: 'Example: v0.0.1'
    #     required: true

permissions:
  id-token: write # Mandatory for Azure OIDC authentication
  contents: read # Allow checkout

env:
  CLUSTER_RESOURCE_GROUP: 'rg-mydemo-az-asse-dev-001'
  CLUSTER_NAME: 'aks-mydemo-az-asse-dev-001'
  EMAIL: '${{ vars.CERT_MANAGER_EMAIL }}'

jobs:
  deploy-microservice:
    name: Deploy Microservice
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pipelines
        uses: actions/checkout@v2

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Log in with Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_MI_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set Kubernetes Context
        id: aks-login
        run: |
          az aks get-credentials --resource-group ${{ env.CLUSTER_RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }} --overwrite-existing
          # kubelogin convert-kubeconfig -l azurecli -t ""

      - name: Add Helm Repositories
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add jetstack https://charts.jetstack.io
          helm repo update

      - name: 'Deployment Ingress'
        run: |
          helm upgrade --install ingress ingress-nginx/ingress-nginx -f deploy/ingress-values.yaml \
          --set controller.service.type=LoadBalancer \
          --set controller.service.externalTrafficPolicy=Local \
          --namespace ingress --create-namespace \
          --wait

      - name: 'Deploy Cert-manager'
        run: |
          helm upgrade --install cert-manager jetstack/cert-manager \
          --namespace cert-manager --create-namespace --set installCRDs=true \
          --set 'extraArgs={--dns01-recursive-nameservers=8.8.8.8:53\,1.1.1.1:53}' \
          --wait

      - name: Create DuckDNS Secret for Cert-Manager
        run: |
            git clone https://github.com/ebrianne/cert-manager-webhook-duckdns.git
            cd cert-manager-webhook-duckdns           
            helm install cert-manager-webhook-duckdns \
            --namespace cert-manager \
            --set duckdns.token=${{ secrets.DUCKDNS_API_TOKEN }}' \
            --set clusterIssuer.production.create=true \
            --set clusterIssuer.staging.create=true \
            --set clusterIssuer.email=${EMAIL} \
            --set logLevel=2 \
            ./deploy/cert-manager-webhook-duckdns

      # - name: Create DuckDNS Secret for Cert-Manager
      #   run: |
      #     # The token is securely passed from GitHub Secrets into the kubectl command.
      #     kubectl create secret generic duckdns-token-secret \
      #       --from-literal=token=${{ secrets.DUCKDNS_API_TOKEN }} \
      #       --namespace cert-manager \
      #       --dry-run=client -o yaml | kubectl apply -f -
      
      # - name: Install DuckDNS Webhook and Issuer
      #   run: |
      #     helm upgrade --install cert-manager-duckdns-webhook duckdns-webhook/cert-manager-duckdns-webhook \
      #       --namespace cert-manager \
      #       --set clusterIssuer.email="${EMAIL}" \
      #       --set clusterIssuer.production.create=true \
      #       --set clusterIssuer.staging.create=true \
      #       --set token.existingSecretName=duckdns-token-secret \
      #       --wait